<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>全球 VPS 价值计算器 (Pro) | NKX Tools</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        // 【修改点1：字体栈优化】
                        // 将系统原生 UI 字体放在最前面，优先使用设备自带的最佳字体渲染数字
                        // 这样能达到图二那种更自然、清晰的效果
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Inter', 'Noto Sans SC', 'sans-serif'],
                        mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    boxShadow: { 'soft': '0 8px 30px -6px rgba(0, 0, 0, 0.08)' }
                }
            }
        }
    </script>
    <style>
        .input-base { height: 3rem; appearance: none; -webkit-appearance: none; background-color: transparent; }
        input[type="date"] { display: block; -webkit-appearance: none; min-height: 3rem; line-height: 3rem; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .dark .glass-panel { background: rgba(17, 24, 39, 0.85); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* 截图专用样式 - 针对字体渲染优化 */
        .capturing .glass-bg-fix { 
            backdrop-filter: none !important;
            box-shadow: none !important; 
            border: 1px solid #e2e8f0 !important;
            border-radius: 24px !important;
            /* 强制开启字体平滑，让文字边缘更清晰 */
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            /* 尝试优化图片渲染 */
            image-rendering: -webkit-optimize-contrast;
        }
        
        .dark .capturing .glass-bg-fix { 
            background: #0f172a !important;
            border: 1px solid #1e293b !important;
        }
        
        select option { font-size: 13px; padding: 4px; }
        
        .watermark-text {
            background: linear-gradient(90deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="min-h-screen bg-[#F8FAFC] dark:bg-[#020617] text-slate-800 dark:text-slate-200 transition-colors duration-300 pb-20">

    <nav class="fixed top-0 w-full z-50 px-4 h-16 flex items-center justify-between bg-white/80 dark:bg-[#0f172a]/80 backdrop-blur-md border-b border-slate-200/60 dark:border-slate-800/60 transition-all">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-blue-500/20">N</div>
            <span class="font-bold text-lg tracking-tight text-slate-800 dark:text-white">NKX Tools</span>
        </div>
        <div>
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 transition flex items-center justify-center text-slate-600 dark:text-yellow-400">
                <i class="fa-solid fa-moon text-sm hidden dark:block"></i>
                <i class="fa-solid fa-sun text-sm dark:hidden"></i>
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 max-w-lg lg:max-w-6xl">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
            
            <div class="lg:col-span-7">
                <div class="glass-panel rounded-3xl p-6 md:p-8 shadow-soft space-y-6">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold flex items-center gap-3 text-slate-800 dark:text-white">
                            <span class="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg"><i class="fa-solid fa-calculator"></i></span>
                            <span>VPS 估值计算</span>
                        </h1>
                        <span id="base-rate-tag" class="text-[11px] font-mono bg-slate-100 dark:bg-slate-800 text-slate-500 px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 flex items-center gap-2 transition-all">
                            <i class="fa-solid fa-spinner fa-spin"></i> 汇率更新中...
                        </span>
                    </div>

                    <form id="calcForm" class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">商家品牌 (Brand)</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-server text-sm"></i></div>
                                    <input type="text" id="brand" placeholder="如: DMIT" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-10 pr-4 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-medium text-sm text-slate-800 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">产品型号 (Model)</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-microchip text-sm"></i></div>
                                    <input type="text" id="product" placeholder="如: LAX.AN4.EB.CORONA" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-10 pr-4 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-medium text-sm text-slate-800 dark:text-white">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-5">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">续费价格</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-tag text-sm"></i></div>
                                    <input type="number" id="price" step="0.01" placeholder="0.00" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-9 pr-2 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono font-bold text-slate-800 dark:text-white">
                                </div>
                            </div>
                            <div class="col-span-7">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">币种 (支持搜索)</label>
                                <div class="relative">
                                    <select id="currency" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-3 pr-8 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono text-xs sm:text-sm cursor-pointer text-slate-700 dark:text-slate-200 truncate">
                                        <option value="USD">加载中...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">付款周期</label>
                            <div class="relative">
                                <select id="cycle" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-4 pr-10 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-medium text-sm text-slate-700 dark:text-slate-200 cursor-pointer appearance-none">
                                    <option value="monthly">月付 (Monthly)</option>
                                    <option value="quarterly">季付 (Quarterly)</option>
                                    <option value="semi-annually">半年付 (Semi-Annually)</option>
                                    <option value="annually" selected>年付 (Annually)</option>
                                    <option value="biennially">两年付 (Biennially)</option>
                                    <option value="triennially">三年付 (Triennially)</option>
                                    <option value="lifetime">一次性 / 买断 (Lifetime)</option>
                                    <option value="custom">自定义周期 (Custom)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-repeat text-xs"></i></div>
                            </div>
                        </div>

                        <div class="bg-slate-50/80 dark:bg-slate-800/40 rounded-xl border border-slate-100 dark:border-slate-700/50 p-2 grid grid-cols-2 gap-2">
                            <div class="bg-white dark:bg-slate-900 rounded-lg px-3 py-1.5 border border-slate-200/50 dark:border-slate-700 shadow-sm relative transition-all focus-within:ring-1 focus-within:ring-blue-500">
                                <label class="text-[10px] font-bold text-slate-400 block mb-0.5">本期开始</label>
                                <input type="date" id="startDate" class="w-full bg-transparent border-none p-0 h-7 text-sm font-medium text-slate-700 dark:text-slate-200 outline-none dark:[color-scheme:dark]">
                            </div>
                            <div class="bg-white dark:bg-slate-900 rounded-lg px-3 py-1.5 border border-slate-200/50 dark:border-slate-700 shadow-sm relative transition-all focus-within:ring-1 focus-within:ring-blue-500">
                                <div class="flex justify-between items-center mb-0.5">
                                    <label class="text-[10px] font-bold text-slate-400 block">本期结束</label>
                                    <span id="auto-date-badge" class="text-[9px] bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 px-1.5 rounded-full hidden">自动</span>
                                </div>
                                <input type="date" id="endDate" class="w-full bg-transparent border-none p-0 h-7 text-sm font-medium text-slate-700 dark:text-slate-200 outline-none dark:[color-scheme:dark]">
                            </div>
                        </div>

                        <div>
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">溢价 / 折价 (CNY)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none font-bold text-slate-400 text-sm">¥</div>
                                <input type="number" id="markup" value="0" placeholder="0" class="input-base w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-10 pr-4 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono text-slate-800 dark:text-white">
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 ml-1 flex items-center gap-1"><i class="fa-solid fa-circle-info"></i> 正数为溢价(加钱)，负数为折价</p>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-6 lg:sticky lg:top-24 h-fit">
                <div class="glass-panel rounded-3xl p-6 shadow-soft">
                    <div class="flex justify-between items-center mb-5">
                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center">
                            <i class="fa-solid fa-gem mr-1.5 text-blue-500"></i>资产快照
                        </span>
                    </div>

                    <div id="captureArea" class="glass-bg-fix relative w-full bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl p-7 border border-slate-100 dark:border-slate-700 shadow-xl overflow-hidden select-none transition-all">
                        
                        <div class="flex justify-between items-start mb-8">
                            <div class="flex-1 pr-4">
                                <h3 id="res-provider" class="text-2xl font-extrabold text-slate-900 dark:text-white leading-tight tracking-tight mb-1">Brand Model</h3>
                                <div class="flex items-center gap-2">
                                    <p id="res-date" class="text-[10px] font-medium text-slate-400 font-mono bg-slate-100 dark:bg-slate-800 px-1.5 rounded">YYYY-MM-DD</p>
                                </div>
                            </div>
                            <div id="res-cycle-badge" class="shrink-0 whitespace-nowrap px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide shadow-sm bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                                年付
                            </div>
                        </div>

                        <div class="flex gap-8 mb-8 pb-8 border-b border-dashed border-slate-200 dark:border-slate-700/60">
                            <div class="min-w-fit whitespace-nowrap">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5">原始价格</p>
                                <p id="res-orig-price" class="text-base font-mono font-bold text-slate-700 dark:text-slate-200">---</p>
                            </div>
                            <div class="min-w-fit whitespace-nowrap">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5">剩余有效期</p>
                                <p id="res-days" class="text-base font-mono font-bold text-emerald-600 dark:text-emerald-400">0 天</p>
                            </div>
                        </div>

                        <div class="mb-8 relative z-10">
                            <p class="text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 flex items-center gap-2">
                                <span>当前价值估算 (CNY)</span>
                            </p>
                            <div class="flex items-baseline">
                                <span id="res-final-cny" class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 dark:from-blue-400 dark:via-indigo-400 dark:to-purple-400 tracking-tight pr-2 pb-1 leading-none">
                                    ¥ 0.00
                                </span>
                                <span id="res-final-usd" class="ml-2 text-sm font-mono font-medium text-slate-400 dark:text-slate-500 opacity-80">
                                    ($ 0.00)
                                </span>
                            </div>
                            <div class="mt-3 flex items-center gap-3 text-[10px] font-medium text-slate-400 dark:text-slate-500 bg-slate-50 dark:bg-slate-800/50 w-fit px-3 py-1.5 rounded-lg border border-slate-100 dark:border-slate-700/50">
                                <span>残值: <b id="res-base-val" class="text-slate-600 dark:text-slate-300">¥0</b></span>
                                <span class="text-slate-300">|</span>
                                <span>溢价: <b id="res-markup" class="text-slate-600 dark:text-slate-300">¥0</b></span>
                            </div>
                        </div>

                        <div class="mb-6 relative z-10">
                             <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                <div id="res-progress" class="h-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 rounded-full relative" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-[9px] font-mono font-medium text-slate-400 mt-2 opacity-80">
                                <span id="res-start">Start</span>
                                <span class="text-indigo-500 font-bold" id="res-percent">0%</span>
                                <span id="res-end">End</span>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center opacity-80">
                            <div class="flex items-center gap-1.5">
                                <div class="w-4 h-4 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-sm flex items-center justify-center text-[8px] text-white font-bold">N</div>
                                <span class="text-[9px] font-bold tracking-widest uppercase text-slate-400 watermark-text">Powered by NKX Tools</span>
                            </div>
                            <div class="text-[8px] text-slate-300 dark:text-slate-600 font-mono">tools.nkx.moe</div>
                        </div>

                        <div class="absolute right-0 top-0 opacity-[0.03] dark:opacity-[0.05] pointer-events-none">
                            <i class="fa-solid fa-server text-[180px] text-slate-900 dark:text-white transform rotate-12 translate-x-12 -translate-y-8"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="copyImage()" class="btn-action text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-4 py-3 rounded-xl font-bold active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700">
                            <i class="fa-regular fa-copy"></i> 复制图片
                        </button>
                        <button onclick="downloadImage()" class="btn-action text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-4 py-3 rounded-xl font-bold active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700">
                            <i class="fa-solid fa-download"></i> 保存图片
                        </button>
                    </div>
                    
                    <button id="uploadBtn" onclick="uploadAndGenLink()" class="w-full mt-3 text-sm bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-3.5 rounded-xl font-bold active:scale-95 transition flex items-center justify-center gap-2 shadow-lg shadow-blue-500/25 group">
                        <i class="fa-solid fa-cloud-arrow-up group-hover:-translate-y-0.5 transition-transform"></i> 上传并生成链接
                    </button>

                    <div id="uploadResult" class="hidden mt-4 space-y-3 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700/50 animate-in fade-in slide-in-from-top-2 duration-300">
                        
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 flex items-center justify-between">
                                <span class="flex items-center gap-1.5"><i class="fa-brands fa-markdown text-blue-500"></i> Markdown</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="mdLink" readonly class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 dark:text-slate-300 focus:outline-none focus:border-blue-500 transition-colors">
                                <button onclick="copyInput('mdLink')" class="shrink-0 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 px-3 rounded-lg text-xs font-bold hover:bg-blue-100 dark:hover:bg-blue-900/40 transition">复制</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1.5 flex items-center gap-1.5">
                                <i class="fa-solid fa-link text-orange-500"></i> 图片直链 (Direct Link)
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="htmlLink" readonly class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 dark:text-slate-300 focus:outline-none focus:border-orange-500 transition-colors">
                                <button onclick="copyInput('htmlLink')" class="shrink-0 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 px-3 rounded-lg text-xs font-bold hover:bg-orange-100 dark:hover:bg-orange-900/40 transition">复制</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
        <div class="glass-panel px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            <i id="toast-icon" class="fa-solid fa-circle-check text-emerald-500 text-lg"></i>
            <span id="toast-msg" class="font-bold text-sm text-slate-700 dark:text-slate-200">操作成功</span>
        </div>
    </div>

    <script>
        // 1. 配置
        const JUMP_URL = "https://tools.nkx.moe/vps/index.html";
        const API_URL = "upload.php"; 

        // 2. 完整货币字典
        const currencyDict = {
            "USD": { cn: "美元", en: "US Dollar", s: "$" }, "CNY": { cn: "人民币", en: "Chinese Yuan", s: "¥" },
            "EUR": { cn: "欧元", en: "Euro", s: "€" }, "GBP": { cn: "英镑", en: "British Pound", s: "£" },
            "JPY": { cn: "日元", en: "Japanese Yen", s: "¥" }, 
            "HKD": { cn: "港币", en: "HK Dollar", s: "HKD" }, 
            "TWD": { cn: "新台币", en: "Taiwan Dollar", s: "TWD" }, 
            "SGD": { cn: "新加坡元", en: "Singapore Dollar", s: "SGD" }, 
            "AUD": { cn: "澳元", en: "Australian Dollar", s: "AUD" }, 
            "CAD": { cn: "加元", en: "Canadian Dollar", s: "CAD" }, 
            "KRW": { cn: "韩元", en: "South Korean Won", s: "₩" }, "RUB": { cn: "卢布", en: "Russian Ruble", s: "₽" },
            "TRY": { cn: "土耳其里拉", en: "Turkish Lira", s: "₺" }, "INR": { cn: "印度卢比", en: "Indian Rupee", s: "₹" },
            "THB": { cn: "泰铢", en: "Thai Baht", s: "฿" }, "VND": { cn: "越南盾", en: "Vietnamese Dong", s: "₫" },
            "MYR": { cn: "林吉特", en: "Malaysian Ringgit", s: "RM" }, "PHP": { cn: "菲律宾比索", en: "Philippine Peso", s: "₱" },
            "IDR": { cn: "印尼盾", en: "Indonesian Rupiah", s: "Rp" }, "BRL": { cn: "巴西雷亚尔", en: "Brazilian Real", s: "R$" },
            "MXN": { cn: "墨西哥比索", en: "Mexican Peso", s: "$" }, "ZAR": { cn: "南非兰特", en: "South African Rand", s: "R" },
            "AED": { cn: "迪拉姆", en: "UAE Dirham", s: "dh" }, "SAR": { cn: "里亚尔", en: "Saudi Riyal", s: "﷼" },
            "CHF": { cn: "瑞士法郎", en: "Swiss Franc", s: "Fr" }, "SEK": { cn: "瑞典克朗", en: "Swedish Krona", s: "kr" },
            "NOK": { cn: "挪威克朗", en: "Norwegian Krone", s: "kr" }, "DKK": { cn: "丹麦克朗", en: "Danish Krone", s: "kr" },
            "NZD": { cn: "新西兰元", en: "NZ Dollar", s: "$" }, "PLN": { cn: "兹罗提", en: "Polish Zloty", s: "zł" },
            "UAH": { cn: "格里夫纳", en: "Ukrainian Hryvnia", s: "₴" }, "EGP": { cn: "埃及镑", en: "Egyptian Pound", s: "E£" },
            "ARS": { cn: "阿根廷比索", en: "Argentine Peso", s: "$" }, "CLP": { cn: "智利比索", en: "Chilean Peso", s: "$" },
            "COP": { cn: "哥伦比亚比索", en: "Colombian Peso", s: "$" }, "PEN": { cn: "索尔", en: "Peruvian Sol", s: "S/" },
            "PKR": { cn: "巴基斯坦卢比", en: "Pakistani Rupee", s: "₨" }, "KZT": { cn: "坚戈", en: "Kazakhstani Tenge", s: "₸" },
            "NGN": { cn: "奈拉", en: "Nigerian Naira", s: "₦" }, "BDT": { cn: "塔卡", en: "Bangladeshi Taka", s: "৳" },
            "ILS": { cn: "谢克尔", en: "Israeli Shekel", s: "₪" }, "HUF": { cn: "福林", en: "Hungarian Forint", s: "Ft" },
            "CZK": { cn: "捷克克朗", en: "Czech Koruna", s: "Kč" }, "RON": { cn: "列伊", en: "Romanian Leu", s: "lei" },
            "QAR": { cn: "里亚尔", en: "Qatari Rial", s: "﷼" }, "KWD": { cn: "第纳尔", en: "Kuwaiti Dinar", s: "KD" },
            "MAD": { cn: "迪拉姆", en: "Moroccan Dirham", s: "MAD" }, "OMR": { cn: "里亚尔", en: "Omani Rial", s: "﷼" },
            "DZD": { cn: "第纳尔", en: "Algerian Dinar", s: "DA" }, "LKR": { cn: "卢比", en: "Sri Lankan Rupee", s: "Rs" },
            "NPR": { cn: "卢比", en: "Nepalese Rupee", s: "₨" }, "AFN": { cn: "阿富汗尼", en: "Afghan Afghani", s: "؋" },
            "ALL": { cn: "列克", en: "Albanian Lek", s: "L" }, "AMD": { cn: "德拉姆", en: "Armenian Dram", s: "֏" },
            "ANG": { cn: "盾", en: "Neth. Antillean Guilder", s: "ƒ" }, "AOA": { cn: "宽扎", en: "Angolan Kwanza", s: "Kz" },
            "AWG": { cn: "弗罗林", en: "Aruban Florin", s: "ƒ" }, "AZN": { cn: "马纳特", en: "Azerbaijani Manat", s: "₼" },
            "BAM": { cn: "马克", en: "Bosnia-Herzegovina Mark", s: "KM" }, "BBD": { cn: "元", en: "Barbadian Dollar", s: "$" },
            "BGN": { cn: "列弗", en: "Bulgarian Lev", s: "лв" }, "BHD": { cn: "第纳尔", en: "Bahraini Dinar", s: ".د.ب" },
            "BIF": { cn: "法郎", en: "Burundian Franc", s: "FBu" }, "BMD": { cn: "元", en: "Bermudan Dollar", s: "$" },
            "BND": { cn: "元", en: "Brunei Dollar", s: "$" }, "BOB": { cn: "诺", en: "Bolivian Boliviano", s: "Bs." },
            "BSD": { cn: "元", en: "Bahamian Dollar", s: "$" }, "BTN": { cn: "努", en: "Bhutanese Ngultrum", s: "Nu." },
            "BWP": { cn: "普拉", en: "Botswanan Pula", s: "P" }, "BYN": { cn: "卢布", en: "Belarusian Ruble", s: "Br" },
            "BZD": { cn: "元", en: "Belize Dollar", s: "BZ$" }, "CDF": { cn: "法郎", en: "Congolese Franc", s: "FC" },
            "CRC": { cn: "科朗", en: "Costa Rican Colón", s: "₡" }, "CUP": { cn: "比索", en: "Cuban Peso", s: "$" },
            "CVE": { cn: "埃斯库多", en: "Cape Verdean Escudo", s: "$" }, "DJF": { cn: "法郎", en: "Djiboutian Franc", s: "Fdj" },
            "DOP": { cn: "比索", en: "Dominican Peso", s: "RD$" }, "ERN": { cn: "纳克法", en: "Eritrean Nakfa", s: "Nfk" },
            "ETB": { cn: "比尔", en: "Ethiopian Birr", s: "Br" }, "FJD": { cn: "元", en: "Fijian Dollar", s: "$" },
            "FKP": { cn: "镑", en: "Falkland Islands Pound", s: "£" }, "FOK": { cn: "克朗", en: "Faroese Króna", s: "kr" },
            "GEL": { cn: "拉里", en: "Georgian Lari", s: "₾" }, "GGP": { cn: "镑", en: "Guernsey Pound", s: "£" },
            "GHS": { cn: "塞地", en: "Ghanaian Cedi", s: "₵" }, "GIP": { cn: "镑", en: "Gibraltar Pound", s: "£" },
            "GMD": { cn: "达拉西", en: "Gambian Dalasi", s: "D" }, "GNF": { cn: "法郎", en: "Guinean Franc", s: "FG" },
            "GTQ": { cn: "格查尔", en: "Guatemalan Quetzal", s: "Q" }, "GYD": { cn: "元", en: "Guyanaese Dollar", s: "$" },
            "HNL": { cn: "伦皮拉", en: "Honduran Lempira", s: "L" }, "HRK": { cn: "库纳", en: "Croatian Kuna", s: "kn" },
            "HTG": { cn: "古德", en: "Haitian Gourde", s: "G" }, "IMP": { cn: "镑", en: "Isle of Man Pound", s: "£" },
            "IQD": { cn: "第纳尔", en: "Iraqi Dinar", s: "ع.د" }, "IRR": { cn: "里亚尔", en: "Iranian Rial", s: "﷼" },
            "ISK": { cn: "克朗", en: "Icelandic Króna", s: "kr" }, "JEP": { cn: "镑", en: "Jersey Pound", s: "£" },
            "JMD": { cn: "元", en: "Jamaican Dollar", s: "J$" }, "JOD": { cn: "第纳尔", en: "Jordanian Dinar", s: "JD" },
            "KES": { cn: "先令", en: "Kenyan Shilling", s: "KSh" }, "KGS": { cn: "索姆", en: "Kyrgystani Som", s: "с" },
            "KHR": { cn: "瑞尔", en: "Cambodian Riel", s: "៛" }, "KID": { cn: "元", en: "Kiribati Dollar", s: "$" },
            "KMF": { cn: "法郎", en: "Comorian Franc", s: "CF" }, "KYD": { cn: "元", en: "Cayman Islands Dollar", s: "$" }, "LAK": { cn: "基普", en: "Laotian Kip", s: "₭" },
            "LBP": { cn: "镑", en: "Lebanese Pound", s: "£" }, "LRD": { cn: "元", en: "Liberian Dollar", s: "$" },
            "LSL": { cn: "洛蒂", en: "Lesotho Loti", s: "L" }, "LYD": { cn: "第纳尔", en: "Libyan Dinar", s: "LD" },
            "MDL": { cn: "列伊", en: "Moldovan Leu", s: "L" }, "MGA": { cn: "阿里亚里", en: "Malagasy Ariary", s: "Ar" },
            "MKD": { cn: "代纳尔", en: "Macedonian Denar", s: "ден" }, "MMK": { cn: "缅元", en: "Myanmar Kyat", s: "K" },
            "MNT": { cn: "图格里克", en: "Mongolian Tugrik", s: "₮" }, "MOP": { cn: "澳门元", en: "Macanese Pataca", s: "MOP$" },
            "MRU": { cn: "乌吉亚", en: "Mauritanian Ouguiya", s: "UM" }, "MUR": { cn: "卢比", en: "Mauritian Rupee", s: "₨" },
            "MVR": { cn: "拉菲亚", en: "Maldivian Rufiyaa", s: "Rf" }, "MWK": { cn: "克瓦查", en: "Malawian Kwacha", s: "MK" },
            "MZN": { cn: "梅蒂卡尔", en: "Mozambican Metical", s: "MT" }, "NAD": { cn: "元", en: "Namibian Dollar", s: "$" },
            "NIO": { cn: "科多巴", en: "Nicaraguan Córdoba", s: "C$" }, "PAB": { cn: "巴波亚", en: "Panamanian Balboa", s: "B/." }, "PGK": { cn: "基那", en: "Papua New Guinean Kina", s: "K" },
            "PYG": { cn: "瓜拉尼", en: "Paraguayan Guarani", s: "₲" }, "RSD": { cn: "第纳尔", en: "Serbian Dinar", s: "дин." }, "RWF": { cn: "法郎", en: "Rwandan Franc", s: "FRw" },
            "SBD": { cn: "元", en: "Solomon Islands Dollar", s: "$" }, "SCR": { cn: "卢比", en: "Seychellois Rupee", s: "₨" },
            "SDG": { cn: "镑", en: "Sudanese Pound", s: "SDG" }, "SHP": { cn: "镑", en: "Saint Helena Pound", s: "£" },
            "SLE": { cn: "利昂", en: "Sierra Leonean Leone", s: "Le" }, "SLL": { cn: "利昂", en: "Sierra Leonean Leone", s: "Le" },
            "SOS": { cn: "先令", en: "Somali Shilling", s: "S" }, "SRD": { cn: "元", en: "Surinamese Dollar", s: "$" },
            "SSP": { cn: "镑", en: "South Sudanese Pound", s: "£" }, "STN": { cn: "多布拉", en: "São Tomé and Príncipe Dobra", s: "Db" },
            "SYP": { cn: "镑", en: "Syrian Pound", s: "£" }, "SZL": { cn: "里兰吉尼", en: "Swazi Lilangeni", s: "L" },
            "TJS": { cn: "索莫尼", en: "Tajikistani Somoni", s: "SM" }, "TMT": { cn: "马纳特", en: "Turkmenistani Manat", s: "T" },
            "TND": { cn: "第纳尔", en: "Tunisian Dinar", s: "DT" }, "TOP": { cn: "潘加", en: "Tongan Paʻanga", s: "T$" },
            "TTD": { cn: "元", en: "Trinidad and Tobago Dollar", s: "TT$" }, "TVD": { cn: "元", en: "Tuvaluan Dollar", s: "$" },
            "TZS": { cn: "先令", en: "Tanzanian Shilling", s: "TSh" }, "UGX": { cn: "先令", en: "Ugandan Shilling", s: "USh" },
            "UYU": { cn: "比索", en: "Uruguayan Peso", s: "$U" }, "UZS": { cn: "苏姆", en: "Uzbekistani Som", s: "лв" },
            "VES": { cn: "玻利瓦尔", en: "Venezuelan Bolívar Soberano", s: "Bs.S" }, "VUV": { cn: "瓦图", en: "Vanuatu Vatu", s: "VT" },
            "WST": { cn: "塔拉", en: "Samoan Tala", s: "WS$" }, "XAF": { cn: "法郎", en: "CFA Franc BEAC", s: "FCFA" },
            "XCD": { cn: "元", en: "East Caribbean Dollar", s: "$" }, "XDR": { cn: "提款权", en: "Special Drawing Rights", s: "SDR" },
            "XOF": { cn: "法郎", en: "CFA Franc BCEAO", s: "CFA" }, "XPF": { cn: "法郎", en: "CFP Franc", s: "₣" },
            "YER": { cn: "里亚尔", en: "Yemeni Rial", s: "﷼" }, "ZMW": { cn: "克瓦查", en: "Zambian Kwacha", s: "ZK" },
            "ZWL": { cn: "元", en: "Zimbabwean Dollar", s: "$" }
        };

        const cycleMap = { 'monthly': 1, 'quarterly': 3, 'semi-annually': 6, 'annually': 12, 'biennially': 24, 'triennially': 36, 'lifetime': 120 }; // lifetime 估算为10年
        const cycleConfig = {
            'monthly': { label: '月付', class: 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800' },
            'quarterly': { label: '季付', class: 'bg-teal-100 text-teal-700 dark:bg-teal-900/40 dark:text-teal-300 border-teal-200 dark:border-teal-800' },
            'semi-annually': { label: '半年付', class: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 border-cyan-200 dark:border-cyan-800' },
            'annually': { label: '年付', class: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800' },
            'biennially': { label: '两年付', class: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300 border-indigo-200 dark:border-indigo-800' },
            'triennially': { label: '三年付', class: 'bg-violet-100 text-violet-700 dark:bg-violet-900/40 dark:text-violet-300 border-violet-200 dark:border-violet-800' },
            'lifetime': { label: '一次性', class: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800' },
            'custom': { label: '自定义', class: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-600' }
        };

        let exchangeRates = { USD: 1, CNY: 7.25 };

        // 3. 初始化
        window.onload = function() {
            initTheme(); initDates(); fetchRates(); bindEvents();
        };

        function bindEvents() {
            ['brand', 'product', 'price', 'currency', 'markup'].forEach(id => document.getElementById(id).addEventListener('input', calculate));
            const cycleSel = document.getElementById('cycle');
            const startInp = document.getElementById('startDate');
            const endInp = document.getElementById('endDate');

            function updateEndFromCycle() {
                const cycle = cycleSel.value;
                if (cycle === 'custom' || cycle === 'lifetime' || !startInp.value) { 
                    toggleAutoBadge(false); 
                    endInp.disabled = (cycle === 'lifetime');
                    return; 
                }
                endInp.disabled = false;
                const months = cycleMap[cycle];
                if (months) {
                    const d = new Date(startInp.valueAsNumber);
                    const localDate = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
                    localDate.setMonth(localDate.getMonth() + months);
                    endInp.valueAsDate = localDate;
                    toggleAutoBadge(true);
                }
                calculate();
            }
            cycleSel.addEventListener('change', updateEndFromCycle);
            startInp.addEventListener('change', updateEndFromCycle);
            
            // 核心修改：当手动修改日期时，不再强制跳转到“自定义”，仅隐藏“自动”标签
            endInp.addEventListener('change', () => { 
                toggleAutoBadge(false); 
                // cycleSel.value = 'custom';  <-- 这行删掉了
                calculate(); 
            });
        }

        function toggleAutoBadge(show) { document.getElementById('auto-date-badge').className = show ? "text-[9px] bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 px-1.5 rounded-full" : "hidden"; }

        function calculate() {
            const brand = document.getElementById('brand').value.trim();
            const product = document.getElementById('product').value.trim();
            const providerName = (brand || product) ? `${brand} ${product}`.trim() : "未命名服务器";
            const price = parseFloat(document.getElementById('price').value) || 0;
            const currency = document.getElementById('currency').value;
            const cycle = document.getElementById('cycle').value;
            const markup = parseFloat(document.getElementById('markup').value) || 0;
            const startTs = document.getElementById('startDate').valueAsNumber;
            const endTs = document.getElementById('endDate').valueAsNumber;

            // 动态更新右上角汇率显示
            const currentRateToCNY = (exchangeRates['CNY'] || 7.25) / (exchangeRates[currency] || 1);
            const tag = document.getElementById('base-rate-tag');
            if(tag) {
                tag.innerHTML = `<i class="fa-solid fa-check text-emerald-500 mr-1"></i> 1 ${currency} ≈ ${currentRateToCNY.toFixed(2)} CNY`;
            }

            if (cycle === 'lifetime') {
                const curInfo = currencyDict[currency] || { s: currency };
                const originRate = exchangeRates[currency] || 1;
                const cnyRate = exchangeRates['CNY'] || 7.25;
                const valCNY = (price / originRate) * cnyRate;
                
                renderUI({
                    provider: providerName, date: new Date().toLocaleDateString(),
                    cycleConfig: cycleConfig['lifetime'], origPriceStr: `${curInfo.s} ${price.toFixed(2)}`,
                    remainingDays: '∞', progress: 100, startStr: '---', endStr: '永久有效',
                    baseCNY: valCNY, finalCNY: valCNY + markup, finalUSD: (valCNY + markup) / cnyRate, markupCNY: markup
                });
                return;
            }

            if (!startTs || !endTs || endTs <= startTs) { 
                renderUI({ ...getEmptyData(), provider: providerName, cycleConfig: cycleConfig[cycle] || cycleConfig['custom'] }); 
                return; 
            }

            const totalMs = endTs - startTs;
            const now = new Date();
            const todayUTC = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
            
            let remainingMs = endTs - todayUTC;
            if (remainingMs < 0) remainingMs = 0;
            
            let progress = 100 - (remainingMs / totalMs * 100);
            progress = Math.max(0, Math.min(100, progress));
            const remainingDays = Math.ceil(remainingMs / 86400000);
            
            const originRate = exchangeRates[currency] || 1;
            const cnyRate = exchangeRates['CNY'] || 7.25;
            const baseValueOrigin = price * (remainingMs / totalMs);
            const baseValueCNY = (baseValueOrigin / originRate) * cnyRate;
            const finalCNY = baseValueCNY + markup;
            const finalUSD = finalCNY / cnyRate;
            const curInfo = currencyDict[currency] || { s: currency };

            renderUI({
                provider: providerName, date: now.toLocaleDateString(),
                cycleConfig: cycleConfig[cycle] || cycleConfig['custom'],
                origPriceStr: `${curInfo.s} ${price.toFixed(2)}`,
                remainingDays: remainingDays + " 天", progress,
                startStr: new Date(startTs + now.getTimezoneOffset()*60000).toLocaleDateString(),
                endStr: new Date(endTs + now.getTimezoneOffset()*60000).toLocaleDateString(),
                baseCNY: baseValueCNY, finalCNY, finalUSD, markupCNY: markup
            });
        }

        function renderUI(data) {
            setText('res-provider', data.provider); setText('res-date', data.date);
            setText('res-orig-price', data.origPriceStr); setText('res-days', data.remainingDays);
            setText('res-percent', typeof data.progress === 'number' ? data.progress.toFixed(0) + "%" : data.progress);
            document.getElementById('res-progress').style.width = typeof data.progress === 'number' ? `${data.progress}%` : '100%';
            setText('res-start', data.startStr); setText('res-end', data.endStr);
            setText('res-final-cny', `¥ ${formatMoney(data.finalCNY)}`);
            setText('res-final-usd', `($ ${formatMoney(data.finalUSD)})`);
            setText('res-base-val', `¥${formatMoney(data.baseCNY)}`);
            const mkText = data.markupCNY >= 0 ? `+${formatMoney(data.markupCNY)}` : formatMoney(data.markupCNY);
            setText('res-markup', `¥${mkText}`);
            
            const mkEl = document.getElementById('res-markup');
            if(data.markupCNY > 0) mkEl.className = "text-red-500 dark:text-red-400 font-bold ml-0.5";
            else if(data.markupCNY < 0) mkEl.className = "text-emerald-500 dark:text-emerald-400 font-bold ml-0.5";
            else mkEl.className = "text-slate-600 dark:text-slate-300 ml-0.5";

            const badge = document.getElementById('res-cycle-badge');
            if (data.cycleConfig) {
                badge.className = `shrink-0 whitespace-nowrap px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide shadow-sm border ${data.cycleConfig.class}`;
                badge.textContent = data.cycleConfig.label;
            }
        }

        async function captureAndProcess(action) {
            const el = document.getElementById("captureArea");
            document.body.classList.add('capturing');
            
            let originalText, btn;
            if (action === 'upload') {
                btn = document.getElementById('uploadBtn');
                originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin fa-lg"></i>`;
            }

            try {
                // 等待一下让样式生效，防止渲染过快
                await new Promise(r => setTimeout(r, 150));
                
                // 【修改点2：提高清晰度】
                // 检测是否为移动设备
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                // PC端设为 3 (更高清), 移动端保持 2 (防止崩溃)
                const pixelRatio = isMobile ? 2 : 3; 

                const blob = await htmlToImage.toBlob(el, { 
                    quality: 0.95, 
                    pixelRatio: pixelRatio, 
                    backgroundColor: null,
                    // 过滤掉不需要的元素
                    filter: (node) => !node.classList?.contains('exclude-capture')
                });

                if (action === 'copy') {
                    try { await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]); showToast("图片已复制！"); }
                    catch (err) { showToast("手机请用保存按钮", "error"); }
                } else if (action === 'download') {
                    const link = document.createElement('a');
                    link.download = `NKX-VPS-${Date.now()}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    showToast("正在下载...");
                } else if (action === 'upload') {
                    await uploadBlob(blob, btn, originalText);
                }
            } catch (err) {
                console.error(err);
                showToast("生成图片失败", "error");
                if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
            } finally {
                document.body.classList.remove('capturing');
            }
        }

        async function uploadBlob(blob, btn, originalText) {
            const formData = new FormData();
            formData.append('file', blob, 'vps.png');
            
            // 指向同目录下的 PHP 代理文件
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    throw new Error(`HTTP Error ${res.status}`);
                }
                
                const json = await res.json();
                
                if (json.error) throw new Error(json.error);

                let imgUrl = null;
                // 兼容兰空图床 V1/V2 返回格式
                if (json.data && json.data.url) imgUrl = json.data.url;
                else if (json.url) imgUrl = json.url;
                else if (json.src) imgUrl = json.src;
                else if (Array.isArray(json)) imgUrl = json[0].src;

                if (!imgUrl) throw new Error("无法解析返回结果");
                
                if (!imgUrl.startsWith('http')) {
                    imgUrl = `https://img.nkx.moe${imgUrl}`;
                }

                const providerName = document.getElementById('res-provider').innerText;
                const mdCode = `[![${providerName}](${imgUrl})](${JUMP_URL})`;
                const htmlCode = imgUrl;

                document.getElementById('uploadResult').classList.remove('hidden');
                document.getElementById('mdLink').value = mdCode;
                document.getElementById('htmlLink').value = htmlCode;
                
                showToast("上传成功！链接已生成");

            } catch (err) {
                console.error(err);
                alert(`上传失败: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function copyImage() { captureAndProcess('copy'); }
        function downloadImage() { captureAndProcess('download'); }
        function uploadAndGenLink() { captureAndProcess('upload'); }

        function copyInput(id) {
            const input = document.getElementById(id);
            input.select();
            navigator.clipboard.writeText(input.value);
            showToast("已复制！");
        }

        function getEmptyData() { return { date: '-', cycleConfig: cycleConfig['custom'], origPriceStr: '-', remainingDays: 0, progress: 0, startStr: '-', endStr: '-', finalCNY: 0, finalUSD: 0, baseCNY: 0, markupCNY: 0 }; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.textContent = val; }
        function formatMoney(n) { return n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function initDates() {
            const t = new Date(); const n = new Date(t); n.setFullYear(t.getFullYear() + 1);
            document.getElementById('startDate').valueAsDate = t; document.getElementById('endDate').valueAsDate = n;
            toggleAutoBadge(true);
        }
        
        async function fetchRates() {
            const tag = document.getElementById('base-rate-tag');
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                if(data.rates) {
                    exchangeRates = data.rates;
                    populateCurrency(exchangeRates);
                    tag.innerHTML = `<i class="fa-solid fa-check text-emerald-500 mr-1"></i> 1 USD ≈ ${exchangeRates['CNY'].toFixed(2)} CNY`;
                }
            } catch(e) { tag.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-1"></i> 离线模式`; populateCurrency(exchangeRates); }
            finally { calculate(); }
        }
        
        function populateCurrency(rates) {
            const sel = document.getElementById('currency'); const saved = sel.value; sel.innerHTML = '';
            const codes = Object.keys(rates);
            const popular = ['USD', 'CNY', 'EUR', 'GBP', 'JPY', 'HKD', 'TWD', 'SGD'];
            const g1 = document.createElement('optgroup'); g1.label = "常用货币";
            const g2 = document.createElement('optgroup'); g2.label = "全部货币";
            
            const createOpt = (c) => {
                const opt = document.createElement('option'); opt.value = c;
                const i = currencyDict[c] || { cn: '', en: '', s: c };
                let label = c;
                if (i.cn) label += ` - ${i.cn}`;
                if (i.en) label += ` ${i.en}`;
                opt.text = label;
                return opt;
            };

            popular.forEach(c => { if(rates[c]) g1.appendChild(createOpt(c)); });
            codes.filter(c => !popular.includes(c)).sort().forEach(c => { if(rates[c]) g2.appendChild(createOpt(c)); });
            sel.appendChild(g1); sel.appendChild(g2);
            sel.value = saved && rates[saved] ? saved : "USD";
        }
        
        function showToast(msg, type="success") {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            document.getElementById('toast-icon').className = type==="error" ? "fa-solid fa-circle-xmark text-red-500" : "fa-solid fa-circle-check text-emerald-500";
            t.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 2500);
        }
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }
    </script>
</body>
</html>
